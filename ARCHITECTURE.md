# Architecture

Companion docs:
- `README.md`
- `WORKFLOWS.md`
- `docs/integration/INDEX.md`

This repo is a Hugo-based personal site and technical writing portfolio.
The vintage pipeline is optional and produces one Hugo input artifact: `hugo/static/brad.man.txt`.

---

## System boundary

Control plane and execution plane are intentionally split.

- **Control plane** (GitHub Actions): tag handling, AWS start/stop, SSM invocation, artifact extraction, Hugo deploy.
- **Execution plane** (edcloud host): all VAX/PDP-11 orchestration in one script, `scripts/edcloud-vintage-runner.sh`.

Hugo remains the site generator in all modes.

---

## Publish modes

### Local publish (`publish-fast-*`)

1. Sync `resume.yaml` to `hugo/data/resume.yaml`
2. Build: `hugo --source hugo --destination ../site`
3. Deploy `site/` to GitHub Pages

### Vintage publish (`publish-vintage-*`)

1. GitHub Actions authenticates to AWS via static credentials
2. Resolve + start edcloud instance
3. Run one SSM command on edcloud
4. edcloud runner executes the vintage pipeline and emits `brad.man.txt` as base64 markers
5. GitHub Actions writes artifact to `hugo/static/brad.man.txt`
6. Hugo build + GitHub Pages deploy
7. Stop edcloud if workflow started it

---

## Vintage pipeline (pexpect-based, validated)

The pipeline runs inside `scripts/edcloud-vintage-runner.sh` on edcloud.
Orchestration uses **pexpect** driving SIMH emulators via stdin/stdout — not telnet
ports or screen sessions.

### Stages

**Stage A — PDP-11 (nroff render)**

- Input: `build/vintage/brad.1` (troff man page source, generated by Python from `resume.yaml`)
- Process: pexpect boots 2.11BSD on SIMH PDP-11, injects `brad.1` via heredoc, runs `nroff -man`
- Output: `brad.man.txt`
- Status: Validated

**Stage B — VAX (bradman.c compile + generate)**

- Input: `build/vintage/resume.vintage.yaml` (Python-flattened from `resume.yaml`)
- Process: pexpect boots 4.3BSD on SIMH VAX, injects `bradman.c` and `resume.vintage.yaml`,
  compiles with `cc`, runs binary to produce `brad.1`
- Output: `build/vintage/brad.1`
- Status: Validated

**Stage A+B — Connected**

- VAX produces `brad.1`, host courier reads it out, PDP-11 renders it
- Transfer: host-mediated via pexpect (FTP to PDP-11 is not viable — 2.11BSD unix kernel
  has no working Ethernet; netnix kernel crashes on xq init)
- Status: Validated end-to-end

### Key constraints

- **PDP-11 pexpect startup**: the pexpect script spawns SIMH directly (stdin/stdout, no telnet);
  it must process output immediately from process start with no delays.
- PDP-11 requires `mount /usr` before `nroff` and `uudecode` are available.
- VAX console: login as root, no password on 4.3BSD guest.
- Both machines confirmed booting and tool-ready on 2026-02-28.

---

## Key artifacts

Input:
- `resume.yaml`

Generated (internal):
- `build/vintage/resume.vintage.yaml`
- `build/vintage/brad.1`

Published input to Hugo:
- `hugo/static/brad.man.txt`

Site output:
- `site/` (gitignored, generated fresh each CI run)

---

## Operational principles

- Single orchestration implementation for vintage stages (`scripts/edcloud-vintage-runner.sh`).
- CI contains bootstrap logic only; no embedded multi-stage console choreography.
- edcloud lifecycle can be automated end-to-end without manual pre-start.
- Runtime cleanup defaults are deterministic; opt out with `KEEP_RUNTIME=1` for debugging.
