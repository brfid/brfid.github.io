# ARPANET Build Integration - Phase 2
# Topology:
#   [VAX/BSD] <-> [IMP #1] <-> [IMP #2] <-> [PDP-10/TOPS-20]
#
# Full multi-hop ARPANET with two hosts and two IMPs

version: '3.8'

services:
  vax:
    image: jguillaumes/simh-vaxbsd@sha256:1bab805b25a793fd622c29d3e9b677b002cabbdc20d9c42afaeeed542cc42215
    container_name: arpanet-vax
    hostname: vax-host
    ports:
      - "2323:2323"
    volumes:
      - ./build/vax/simh-tape:/machines
    networks:
      arpanet:
        ipv4_address: 172.20.0.10
    environment:
      - SIMH_NETWORK=enabled
    restart: unless-stopped

  imp1:
    build:
      context: ./arpanet
      dockerfile: Dockerfile.imp
    container_name: arpanet-imp1
    hostname: imp-1
    networks:
      arpanet:
        ipv4_address: 172.20.0.20
    volumes:
      - ./build/arpanet/imp1:/machines/data
      - ./arpanet/configs/imp1-phase2.ini:/machines/imp.ini:ro
      - ./arpanet/configs/impcode.simh:/machines/impcode.simh:ro
      - ./arpanet/configs/impconfig.simh:/machines/impconfig.simh:ro
    ports:
      - "2324:2323"
    restart: unless-stopped
    depends_on:
      - vax

  imp2:
    build:
      context: ./arpanet
      dockerfile: Dockerfile.imp
    container_name: arpanet-imp2
    hostname: imp-2
    networks:
      arpanet:
        ipv4_address: 172.20.0.30
    volumes:
      - ./build/arpanet/imp2:/machines/data
      - ./arpanet/configs/imp2.ini:/machines/imp.ini:ro
      - ./arpanet/configs/impcode.simh:/machines/impcode.simh:ro
      - ./arpanet/configs/impconfig.simh:/machines/impconfig.simh:ro
    ports:
      - "2325:2323"
    restart: unless-stopped
    depends_on:
      - imp1
      - pdp10

  pdp10:
    build:
      context: ./arpanet
      dockerfile: Dockerfile.pdp10
    container_name: arpanet-pdp10
    hostname: pdp10-host
    networks:
      arpanet:
        ipv4_address: 172.20.0.40
    volumes:
      - ./build/arpanet/pdp10:/machines/data
      - ./arpanet/configs/pdp10.ini:/machines/pdp10.ini:ro
    ports:
      - "2326:2323"
    restart: unless-stopped

networks:
  arpanet:
    name: arpanet-build
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
