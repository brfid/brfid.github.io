name: Publish Site

# Mode 1: Tag 'publish' or 'publish-*' â†’ Fast publish (local mode)
# Mode 2: Tag 'publish-vax' or 'publish-docker' â†’ Full VAX/Docker build

on:
  push:
    tags:
      - "publish"           # Mode 1: Fast (local)
      - "publish-*"         # Mode 1: Fast variants
      - "!publish-vax*"     # Exclude (handled below)
      - "!publish-docker*"  # Exclude (handled below)
      - "publish-vax"       # Mode 2: VAX/Docker
      - "publish-vax-*"     # Mode 2: VAX/Docker variants
      - "publish-docker"    # Mode 2: VAX/Docker (alias)
      - "publish-docker-*"  # Mode 2: VAX/Docker variants
  workflow_dispatch:
    inputs:
      vax_mode:
        description: 'Build mode (local or docker)'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - docker

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "pyproject.toml"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e '.[dev]'

      - name: Quality checks
        run: |
          # Keep publish checks aligned with CI/test policy to avoid unrelated
          # full-repo lint/type failures during deployment runs.
          python -m ruff check resume_generator
          python -m mypy resume_generator arpanet_logging tests
          python -m pytest -q -m "unit and not docker and not slow"
          python -m pylint resume_generator -sn
          python -m vulture --config pyproject.toml resume_generator

      - name: Determine VAX mode
        id: mode
        run: |
          # Determine mode based on tag name
          TAG_NAME="${{ github.ref_name }}"

          if [[ "$TAG_NAME" == *"vax"* ]] || [[ "$TAG_NAME" == *"docker"* ]]; then
            echo "vax_mode=docker" >> $GITHUB_OUTPUT
            echo "mode_name=VAX/Docker (authentic build)" >> $GITHUB_OUTPUT
            echo "ðŸš€ Building with VAX/Docker mode (authentic 1980s BSD build)"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "vax_mode=${{ inputs.vax_mode }}" >> $GITHUB_OUTPUT
            echo "mode_name=Manual (${{ inputs.vax_mode }})" >> $GITHUB_OUTPUT
            echo "ðŸŽ® Building with manual mode: ${{ inputs.vax_mode }}"
          else
            echo "vax_mode=local" >> $GITHUB_OUTPUT
            echo "mode_name=Local (fast)" >> $GITHUB_OUTPUT
            echo "âš¡ Building with local mode (fast)"
          fi

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: python -m playwright install --with-deps chromium

      - name: Setup SSH key
        if: steps.mode.outputs.vax_mode == 'docker'
        run: |
          echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > /tmp/aws-key.pem
          chmod 600 /tmp/aws-key.pem

      - name: Start AWS VAX instance
        if: steps.mode.outputs.vax_mode == 'docker'
        id: aws_start
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "ðŸš€ Starting AWS VAX instance..."
          aws ec2 start-instances --instance-ids ${{ secrets.AWS_VAX_INSTANCE_ID }}

          echo "â³ Waiting for instance to be running..."
          aws ec2 wait instance-running --instance-ids ${{ secrets.AWS_VAX_INSTANCE_ID }}

          echo "ðŸ“¡ Getting instance IP..."
          VAX_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ secrets.AWS_VAX_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "vax_ip=$VAX_IP" >> $GITHUB_OUTPUT
          echo "âœ… VAX instance ready at $VAX_IP"

          echo "â³ Waiting for SSH to be available..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i /tmp/aws-key.pem ubuntu@$VAX_IP echo "ready" 2>/dev/null; then
              echo "âœ… SSH ready"
              break
            fi
            echo "Attempt $i/30: SSH not ready yet..."
            sleep 10
          done

      - name: Generate site (HTML + PDF + VAX artifacts)
        env:
          VAX_IP: ${{ steps.aws_start.outputs.vax_ip }}
        run: |
          echo "ðŸ”¨ Building resume with VAX mode: ${{ steps.mode.outputs.vax_mode }}"

          if [[ "${{ steps.mode.outputs.vax_mode }}" == "docker" ]]; then
            echo "ðŸ–¥ï¸  Using AWS VAX instance at $VAX_IP"

            # Generate resume.vax.yaml locally
            python -m resume_generator --out site --with-vax --vax-mode local

            # Transfer to VAX
            echo "ðŸ“¤ Transferring files to VAX..."
            scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
              build/vax/resume.vax.yaml \
              ubuntu@$VAX_IP:/tmp/resume.vax.yaml

            scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
              vax/bradman.c \
              ubuntu@$VAX_IP:/tmp/bradman.c

            # Run build on VAX
            echo "ðŸ”¨ Running build on AWS VAX (4.3BSD)..."
            ssh -o StrictHostKeyChecking=no -i /tmp/aws-key.pem ubuntu@$VAX_IP \
              'cc -o /tmp/bradman /tmp/bradman.c && /tmp/bradman -i /tmp/resume.vax.yaml -o /tmp/brad.1 && echo "âœ… VAX build complete"'

            # Retrieve output
            echo "ðŸ“¥ Retrieving build output..."
            scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
              ubuntu@$VAX_IP:/tmp/brad.1 \
              build/vax/brad.1

            # Render to text
            python -m resume_generator.manpage --in build/vax/brad.1 --out site/brad.man.txt

            echo "âœ… AWS VAX build complete"
          else
            python -m resume_generator --out site --with-vax \
              --vax-mode ${{ steps.mode.outputs.vax_mode }}
          fi

      - name: Capture VAX build logs (Docker mode only)
        if: steps.mode.outputs.vax_mode == 'docker'
        run: |
          echo "ðŸ“‹ Capturing VAX build logs..."
          mkdir -p site/vax-logs

          # Copy VAX build log if it exists
          if [[ -f site/vax-build.log ]]; then
            cp site/vax-build.log site/vax-logs/
          fi

          # Create enhanced build log summary
          cat > site/vax-logs/build-summary.txt << 'EOF'
          VAX/BSD Build Summary
          =====================
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Mode: Docker (authentic 4.3BSD VAX 11/780)

          Build Steps:
          1. Resume YAML â†’ VAX-friendly subset
          2. Transfer to VAX via SIMH tape
          3. Compile bradman.c (K&R C)
          4. Generate manpage (roff format)
          5. Extract and render artifacts

          Status: âœ… Build complete
          EOF

          echo "âœ… Logs captured to site/vax-logs/"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Stop AWS VAX instance
        if: always() && steps.mode.outputs.vax_mode == 'docker'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "ðŸ›‘ Stopping AWS VAX instance..."
          aws ec2 stop-instances --instance-ids ${{ secrets.AWS_VAX_INSTANCE_ID }}
          echo "âœ… Instance stopped (cost savings mode)"

      - name: Summary
        run: |
          echo "## âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ steps.mode.outputs.mode_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
