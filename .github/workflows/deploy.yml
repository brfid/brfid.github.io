name: Publish Site

# Mode 3: Tag 'publish' or 'publish-*' â†’ Fast publish (local/transcript)
# Mode 4: Tag 'publish-arpanet' or 'publish-full' â†’ Full ARPANET build

on:
  push:
    tags:
      - "publish"           # Mode 3: Fast (local)
      - "publish-*"         # Mode 3: Fast variants
      - "!publish-arpanet*" # Exclude (handled below)
      - "!publish-full*"    # Exclude (handled below)
      - "publish-arpanet"   # Mode 4: ARPANET
      - "publish-arpanet-*" # Mode 4: ARPANET variants
      - "publish-full"      # Mode 4: ARPANET (alias)
      - "publish-full-*"    # Mode 4: ARPANET variants
  workflow_dispatch:
    inputs:
      vax_mode:
        description: 'Build mode (local or arpanet)'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - arpanet

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "pyproject.toml"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e '.[dev]'

      - name: Quality checks
        run: |
          python -m ruff check .
          python -m mypy
          python -m pytest -q
          python -m pylint resume_generator tests -sn
          python -m vulture --config pyproject.toml resume_generator

      - name: Determine VAX mode
        id: mode
        run: |
          # Determine mode based on tag name
          TAG_NAME="${{ github.ref_name }}"

          if [[ "$TAG_NAME" == *"arpanet"* ]] || [[ "$TAG_NAME" == *"full"* ]]; then
            echo "vax_mode=docker" >> $GITHUB_OUTPUT
            echo "with_arpanet=true" >> $GITHUB_OUTPUT
            echo "arpanet_execute=true" >> $GITHUB_OUTPUT
            echo "mode_name=ARPANET (full stack)" >> $GITHUB_OUTPUT
            echo "ðŸš€ Building with ARPANET mode (full stack)"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.vax_mode }}" == "arpanet" ]]; then
              echo "vax_mode=docker" >> $GITHUB_OUTPUT
              echo "with_arpanet=true" >> $GITHUB_OUTPUT
              echo "arpanet_execute=true" >> $GITHUB_OUTPUT
            else
              echo "vax_mode=local" >> $GITHUB_OUTPUT
              echo "with_arpanet=false" >> $GITHUB_OUTPUT
              echo "arpanet_execute=false" >> $GITHUB_OUTPUT
            fi
            echo "mode_name=Manual (${{ inputs.vax_mode }})" >> $GITHUB_OUTPUT
            echo "ðŸŽ® Building with manual mode: ${{ inputs.vax_mode }}"
          else
            echo "vax_mode=local" >> $GITHUB_OUTPUT
            echo "with_arpanet=false" >> $GITHUB_OUTPUT
            echo "arpanet_execute=false" >> $GITHUB_OUTPUT
            echo "mode_name=Local (fast)" >> $GITHUB_OUTPUT
            echo "âš¡ Building with local mode (fast)"
          fi

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: python -m playwright install --with-deps chromium

      - name: Start ARPANET network (ARPANET mode only)
        if: steps.mode.outputs.with_arpanet == 'true'
        run: |
          echo "ðŸŒ Starting ARPANET Phase 2 network (VAX + IMP1 + IMP2 + PDP10)..."
          docker compose -f docker-compose.arpanet.phase2.yml build
          docker compose -f docker-compose.arpanet.phase2.yml up -d

          echo "â³ Waiting for VAX boot (60s)..."
          sleep 60

          echo "â³ Waiting for IMP initialization (10s)..."
          sleep 10

          echo "âœ… ARPANET network ready"
          docker ps -a

      - name: Generate site (HTML + PDF + VAX artifacts)
        run: |
          EXTRA_ARGS=""
          if [[ "${{ steps.mode.outputs.with_arpanet }}" == "true" ]]; then
            EXTRA_ARGS="--with-arpanet --arpanet-execute"
          fi

          python -m resume_generator --out site --with-vax \
            --vax-mode ${{ steps.mode.outputs.vax_mode }} \
            ${EXTRA_ARGS}

      - name: Capture ARPANET logs (ARPANET mode only)
        if: steps.mode.outputs.with_arpanet == 'true'
        run: |
          echo "ðŸ“‹ Capturing ARPANET network logs..."
          mkdir -p site/arpanet-logs
          docker logs arpanet-vax > site/arpanet-logs/vax-full.log 2>&1 || true
          docker logs arpanet-imp1 > site/arpanet-logs/imp1-full.log 2>&1 || true
          docker logs arpanet-imp2 > site/arpanet-logs/imp2-full.log 2>&1 || true
          docker logs arpanet-pdp10 > site/arpanet-logs/pdp10-full.log 2>&1 || true
          docker network inspect arpanet-build > site/arpanet-logs/network.json 2>&1 || true
          docker ps -a > site/arpanet-logs/containers.txt 2>&1 || true
          echo "âœ… Logs captured to site/arpanet-logs/"

      - name: Cleanup ARPANET network (ARPANET mode only)
        if: always() && steps.mode.outputs.with_arpanet == 'true'
        run: |
          echo "ðŸ§¹ Cleaning up ARPANET network..."
          docker compose -f docker-compose.arpanet.phase2.yml down -v

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "## âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ steps.mode.outputs.mode_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
