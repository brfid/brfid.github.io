name: Publish Site

# Mode 1: Tag 'publish' or 'publish-*' â†’ Fast publish (local mode)
# Mode 2: Tag 'publish-vax' or 'publish-docker' â†’ Full VAX/Docker build

on:
  push:
    tags:
      - "publish"           # Mode 1: Fast (local)
      - "publish-*"         # Mode 1: Fast variants
      - "!publish-vax*"     # Exclude (handled below)
      - "!publish-docker*"  # Exclude (handled below)
      - "publish-vax"       # Mode 2: VAX/Docker
      - "publish-vax-*"     # Mode 2: VAX/Docker variants
      - "publish-docker"    # Mode 2: VAX/Docker (alias)
      - "publish-docker-*"  # Mode 2: VAX/Docker variants
  workflow_dispatch:
    inputs:
      vax_mode:
        description: 'Build mode (local or docker)'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - docker

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "pyproject.toml"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e '.[dev]'

      - name: Quality checks
        run: |
          # Keep publish checks aligned with CI/test policy to avoid unrelated
          # full-repo lint/type failures during deployment runs.
          python -m ruff check resume_generator
          python -m mypy resume_generator arpanet_logging tests
          python -m pytest -q -m "unit and not docker and not slow"
          python -m pylint resume_generator -sn
          python -m vulture --config pyproject.toml resume_generator

      - name: Determine VAX mode
        id: mode
        run: |
          # Determine mode based on tag name
          TAG_NAME="${{ github.ref_name }}"

          if [[ "$TAG_NAME" == *"vax"* ]] || [[ "$TAG_NAME" == *"docker"* ]]; then
            echo "vax_mode=docker" >> $GITHUB_OUTPUT
            echo "mode_name=VAX/Docker (authentic build)" >> $GITHUB_OUTPUT
            echo "ðŸš€ Building with VAX/Docker mode (authentic 1980s BSD build)"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "vax_mode=${{ inputs.vax_mode }}" >> $GITHUB_OUTPUT
            echo "mode_name=Manual (${{ inputs.vax_mode }})" >> $GITHUB_OUTPUT
            echo "ðŸŽ® Building with manual mode: ${{ inputs.vax_mode }}"
          else
            echo "vax_mode=local" >> $GITHUB_OUTPUT
            echo "mode_name=Local (fast)" >> $GITHUB_OUTPUT
            echo "âš¡ Building with local mode (fast)"
          fi

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: python -m playwright install --with-deps chromium

      - name: Generate build ID
        if: steps.mode.outputs.vax_mode == 'docker'
        id: build_id
        run: |
          BUILD_ID="build-$(date -u '+%Y%m%d-%H%M%S')"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "ðŸ“ Build ID: $BUILD_ID"

      - name: Setup SSH key
        if: steps.mode.outputs.vax_mode == 'docker'
        run: |
          echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > /tmp/aws-key.pem
          chmod 600 /tmp/aws-key.pem

      - name: Start AWS VAX instance
        if: steps.mode.outputs.vax_mode == 'docker'
        id: aws_start
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "ðŸš€ Starting AWS VAX instance..."
          aws ec2 start-instances --instance-ids ${{ secrets.AWS_VAX_INSTANCE_ID }}

          echo "â³ Waiting for instance to be running..."
          aws ec2 wait instance-running --instance-ids ${{ secrets.AWS_VAX_INSTANCE_ID }}

          echo "ðŸ“¡ Getting instance IP..."
          VAX_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ secrets.AWS_VAX_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "vax_ip=$VAX_IP" >> $GITHUB_OUTPUT
          echo "âœ… VAX instance ready at $VAX_IP"

          echo "â³ Waiting for SSH to be available..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i /tmp/aws-key.pem ubuntu@$VAX_IP echo "ready" 2>/dev/null; then
              echo "âœ… SSH ready"
              break
            fi
            echo "Attempt $i/30: SSH not ready yet..."
            sleep 10
          done

      - name: Transfer logging scripts to AWS
        if: steps.mode.outputs.vax_mode == 'docker'
        env:
          VAX_IP: ${{ steps.aws_start.outputs.vax_ip }}
        run: |
          echo "ðŸ“¤ Transferring logging scripts to AWS..."
          scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
            scripts/arpanet-log.sh \
            ubuntu@$VAX_IP:/tmp/arpanet-log.sh

          scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
            scripts/merge-logs.py \
            ubuntu@$VAX_IP:/tmp/merge-logs.py

          ssh -o StrictHostKeyChecking=no -i /tmp/aws-key.pem ubuntu@$VAX_IP \
            'chmod +x /tmp/arpanet-log.sh /tmp/merge-logs.py'

          echo "âœ… Logging scripts transferred"

      - name: Generate site (HTML + PDF + VAX artifacts)
        env:
          VAX_IP: ${{ steps.aws_start.outputs.vax_ip }}
          BUILD_ID: ${{ steps.build_id.outputs.build_id }}
        run: |
          echo "ðŸ”¨ Building resume with VAX mode: ${{ steps.mode.outputs.vax_mode }}"

          if [[ "${{ steps.mode.outputs.vax_mode }}" == "docker" ]]; then
            echo "ðŸ–¥ï¸  Using AWS VAX instance at $VAX_IP"
            echo "ðŸ“ Build ID: $BUILD_ID"

            # Log GitHub Actions activity
            exec > >(tee >(while IFS= read -r line; do echo "[$(date -u '+%Y-%m-%d %H:%M:%S') GITHUB] $line"; done >> /tmp/github.log)) 2>&1

            # Generate resume.vax.yaml locally
            echo "Generating resume.vax.yaml locally..."
            python -m resume_generator --out site --with-vax --vax-mode local

            # Transfer to VAX
            echo "Transferring files to VAX..."
            scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
              build/vax/resume.vax.yaml \
              ubuntu@$VAX_IP:/tmp/resume.vax.yaml

            scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
              vax/bradman.c \
              ubuntu@$VAX_IP:/tmp/bradman.c

            # Run build on VAX with logging
            echo "Running build on AWS VAX (4.3BSD)..."
            ssh -o StrictHostKeyChecking=no -i /tmp/aws-key.pem ubuntu@$VAX_IP \
              "cd /tmp && (cc -o bradman bradman.c 2>&1; ./bradman -i resume.vax.yaml -o brad.1 2>&1; echo 'VAX build complete') | /tmp/arpanet-log.sh VAX $BUILD_ID"

            # Retrieve output
            echo "Retrieving build output..."
            scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
              ubuntu@$VAX_IP:/tmp/brad.1 \
              build/vax/brad.1

            # Render to text
            python -m resume_generator.manpage --in build/vax/brad.1 --out site/brad.man.txt

            echo "AWS VAX build complete"
          else
            python -m resume_generator --out site --with-vax \
              --vax-mode ${{ steps.mode.outputs.vax_mode }}
          fi

      - name: Merge and retrieve build logs
        if: steps.mode.outputs.vax_mode == 'docker'
        env:
          VAX_IP: ${{ steps.aws_start.outputs.vax_ip }}
          BUILD_ID: ${{ steps.build_id.outputs.build_id }}
        run: |
          echo "ðŸ“‹ Merging build logs..."

          # Upload GitHub log to VAX
          if [[ -f /tmp/github.log ]]; then
            echo "Uploading GitHub Actions log..."
            scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
              /tmp/github.log \
              ubuntu@$VAX_IP:/mnt/arpanet-logs/builds/$BUILD_ID/GITHUB.log
          fi

          # Merge logs chronologically on VAX
          echo "Merging logs chronologically..."
          ssh -o StrictHostKeyChecking=no -i /tmp/aws-key.pem ubuntu@$VAX_IP \
            "python3 /tmp/merge-logs.py $BUILD_ID"

          # Retrieve all logs
          echo "Retrieving build logs..."
          mkdir -p site/build-logs

          # Retrieve merged log
          scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
            ubuntu@$VAX_IP:/mnt/arpanet-logs/builds/$BUILD_ID/merged.log \
            site/build-logs/merged.log

          # Retrieve individual component logs
          for component in VAX PDP11 GITHUB; do
            if ssh -o StrictHostKeyChecking=no -i /tmp/aws-key.pem ubuntu@$VAX_IP \
              "test -f /mnt/arpanet-logs/builds/$BUILD_ID/${component}.log"; then
              scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
                ubuntu@$VAX_IP:/mnt/arpanet-logs/builds/$BUILD_ID/${component}.log \
                site/build-logs/${component}.log
            fi
          done

          # Cleanup old builds (keep last 20)
          echo "Cleaning up old builds..."
          ssh -o StrictHostKeyChecking=no -i /tmp/aws-key.pem ubuntu@$VAX_IP \
            'cd /mnt/arpanet-logs/builds && ls -t | tail -n +21 | xargs -r rm -rf'

          echo "âœ… Logs merged and retrieved"

      - name: Generate build info widget
        if: steps.mode.outputs.vax_mode == 'docker'
        env:
          VAX_IP: ${{ steps.aws_start.outputs.vax_ip }}
          BUILD_ID: ${{ steps.build_id.outputs.build_id }}
        run: |
          echo "ðŸ“Š Generating build info widget..."

          # Transfer generate-build-info.py to VAX
          scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
            scripts/generate-build-info.py \
            ubuntu@$VAX_IP:/tmp/generate-build-info.py

          ssh -o StrictHostKeyChecking=no -i /tmp/aws-key.pem ubuntu@$VAX_IP \
            'chmod +x /tmp/generate-build-info.py'

          # Generate build info on VAX
          ssh -o StrictHostKeyChecking=no -i /tmp/aws-key.pem ubuntu@$VAX_IP \
            "python3 /tmp/generate-build-info.py $BUILD_ID /mnt/arpanet-logs /tmp/build-info"

          # Retrieve generated files
          mkdir -p site/build-info
          scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
            ubuntu@$VAX_IP:/tmp/build-info/build-info.json \
            site/build-info/

          scp -o StrictHostKeyChecking=no -i /tmp/aws-key.pem \
            ubuntu@$VAX_IP:/tmp/build-info/build-info.html \
            site/build-info/

          # Copy CSS
          cp templates/build-info.css site/build-info/

          echo "âœ… Build info widget generated"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Stop AWS VAX instance
        if: always() && steps.mode.outputs.vax_mode == 'docker'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "ðŸ›‘ Stopping AWS VAX instance..."
          aws ec2 stop-instances --instance-ids ${{ secrets.AWS_VAX_INSTANCE_ID }}
          echo "âœ… Instance stopped (cost savings mode)"

      - name: Summary
        run: |
          echo "## âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ steps.mode.outputs.mode_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
