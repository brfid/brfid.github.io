# ARPANET Build Integration - Phase 1: VAX + IMP
# This compose file demonstrates the first phase of integrating ARPANET
# components into the build pipeline. It connects the existing VAX/BSD
# system to a simulated IMP (Interface Message Processor).
#
# Topology:
#   [VAX/BSD] ←→ [IMP #1]
#
# Usage:
#   docker-compose -f docker-compose.arpanet.phase1.yml up -d
#   docker-compose -f docker-compose.arpanet.phase1.yml logs -f
#   docker-compose -f docker-compose.arpanet.phase1.yml down

version: '3.8'

services:
  vax:
    image: jguillaumes/simh-vaxbsd@sha256:1bab805b25a793fd622c29d3e9b677b002cabbdc20d9c42afaeeed542cc42215
    container_name: arpanet-vax
    hostname: vax-host
    ports:
      - "2323:2323"  # telnet console for VAX login
      # Note: UDP port 2000 is for inter-container communication only (not exposed to host)
    volumes:
      - ./build/vax/simh-tape:/machines
      # Note: Using base image's default vax780.ini - custom config caused path errors
    networks:
      arpanet:
        ipv4_address: 172.20.0.10
    environment:
      - SIMH_NETWORK=enabled
    restart: unless-stopped

  imp1:
    build:
      context: ./arpanet
      dockerfile: Dockerfile.imp
    container_name: arpanet-imp1
    hostname: imp-1
    networks:
      arpanet:
        ipv4_address: 172.20.0.20
    volumes:
      - ./build/arpanet/imp1:/machines/data
      - ./arpanet/configs/imp-phase1.ini:/machines/imp.ini:ro
      - ./arpanet/configs/impcode.simh:/machines/impcode.simh:ro
      - ./arpanet/configs/impconfig.simh:/machines/impconfig.simh:ro
    environment:
      - IMP_NUMBER=1
      - HOST_LINK_0=172.20.0.10:2000  # Connection to VAX
    ports:
      - "2324:2323"  # telnet console for IMP debugging
      # Note: UDP port 2000 is for inter-container communication only (not exposed to host)
    restart: unless-stopped
    depends_on:
      - vax

networks:
  arpanet:
    name: arpanet-build
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

volumes:
  vax_data:
    driver: local
  imp1_data:
    driver: local
